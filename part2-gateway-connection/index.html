<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Part 2: Taproot Assets Workshop</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000000;
            background-image: url('assets/skyline.jpeg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 0;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        .logo {
            display: block;
            max-width: 400px;
            margin: 0 auto 30px;
        }
        .content-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .right-panel {
            position: sticky;
            top: 20px;
            align-self: start;
        }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        .subtitle {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.1em;
            opacity: 0.95;
        }
        .card {
            background: rgba(26, 26, 46, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .card h3, .card p, .card ul, .card li {
            color: #d0d0d0;
        }
        .card h3 {
            color: #ffffff;
        }
        .warning-banner {
            background: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #ffc107;
            color: #ffecb3;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .setup-banner {
            background: rgba(33, 150, 243, 0.1);
            border-left: 4px solid #2196f3;
            color: #bbdefb;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .setup-banner code {
            background: rgba(0, 0, 0, 0.5);
            color: #00ff41;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            border: 1px solid rgba(0, 255, 65, 0.2);
        }
        .step-group {
            margin-bottom: 25px;
        }
        .step-group h3 {
            color: #ffffff;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .step-number {
            background: rgba(255, 255, 255, 0.9);
            color: #000000;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
        }
        .button {
            background: rgba(255, 255, 255, 0.9);
            color: #000000;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-block;
        }
        .button:hover {
            background: #ffffff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.4);
        }
        .button.clear {
            background: rgba(220, 53, 69, 0.9);
            color: white;
        }
        .input-group {
            margin: 15px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #ffffff;
            font-weight: 600;
            font-size: 14px;
        }
        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.5);
            color: #ffffff;
        }
        .input-group input:focus, .input-group textarea:focus, .input-group select:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(0, 0, 0, 0.6);
        }
        .input-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        .input-hint {
            font-size: 12px;
            color: #a0a0a0;
            margin-top: 5px;
        }
        .response-viewer {
            background: rgba(0, 0, 0, 0.9);
            color: #00ff41;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            min-height: 300px;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            border: 1px solid rgba(0, 255, 65, 0.3);
        }
        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            margin-bottom: 20px;
        }
        .status-indicator.connected {
            background: #c6f6d5;
            color: #22543d;
        }
        .status-indicator.disconnected {
            background: #fed7d7;
            color: #742a2a;
        }
        .status-indicator::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        .status-indicator.connected::before {
            background: #48bb78;
        }
        .status-indicator.disconnected::before {
            background: #f56565;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .info-box {
            background: rgba(33, 150, 243, 0.1);
            border-left: 4px solid #4299e1;
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            font-size: 14px;
            color: #bbdefb;
        }
    </style>
</head>
<body>
    <div class="container">
        <img src="assets/privkey-logo.png" alt="PrivKey LLC" class="logo">
        <h1>üöÄ Part 2: Taproot Assets Workshop</h1>
        <p class="subtitle">Mint, send, and receive assets using the REST Gateway</p>

        <div style="display: flex; justify-content: space-between; margin: 20px 0; gap: 10px;">
            <a href="/part1-cors-demo/" style="background: white; color: #667eea; border: 2px solid white; padding: 12px 24px; border-radius: 6px; font-size: 16px; font-weight: 600; text-decoration: none; display: inline-block;">‚Üê Back to Part 1</a>
            <a href="/part3-starter/" style="background: white; color: #667eea; border: 2px solid white; padding: 12px 24px; border-radius: 6px; font-size: 16px; font-weight: 600; text-decoration: none; display: inline-block;">Next: Part 3 ‚Üí</a>
        </div>

        <div class="setup-banner">
            <strong>‚ö†Ô∏è IMPORTANT: Setup Required!</strong><br>
            1. In Polar: Click LND node (alice) ‚Üí <strong>Deposit Funds</strong> tab ‚Üí Amount: <strong>1000000</strong> ‚Üí Click <strong>Deposit</strong><br>
            2. In Polar: Click Bitcoin node ‚Üí Actions ‚Üí <strong>Auto Mine</strong> ‚Üí Set to <strong>30 seconds</strong> ‚Üí Click <strong>Start</strong><br>
            3. Wait 30-60 seconds for deposit to confirm, then start minting! ‚úÖ
        </div>

        <div class="card" style="margin-bottom: 20px;">
            <h3 style="color: #667eea; margin-bottom: 15px;">üìö Workshop Overview</h3>
            <p style="margin-bottom: 10px;">Complete asset lifecycle in one UI:</p>
            <ul style="margin-left: 20px;">
                <li><strong>Step 1:</strong> Verify gateway is running</li>
                <li><strong>Step 2:</strong> Mint your first asset (two-step: batch ‚Üí finalize)</li>
                <li><strong>Step 3:</strong> View balances (grouped by asset)</li>
                <li><strong>Step 4:</strong> Generate receiving address (auto-filled!)</li>
                <li><strong>Step 5:</strong> Send assets (test by sending to yourself)</li>
                <li><strong>Step 6:</strong> Advanced operations (transfers, universe)</li>
            </ul>
        </div>

        <button onclick="clearConsole()" class="button clear" style="margin-bottom: 20px;">Clear Console</button>

        <div class="content-wrapper">
            <div class="left-panel">
                <!-- Step 1: Verify Setup -->
                <div class="card">
                    <div class="step-group">
                        <h3><span class="step-number">1</span> Verify Gateway Connection</h3>
                        <div id="status" class="status-indicator disconnected">
                            Checking gateway connection...
                        </div>
                        <p style="margin-bottom: 15px; color: #4a5568;">Ensure the REST Gateway is running:</p>
                        <button class="button" onclick="checkHealth()">Check Gateway Health</button>
                        <button class="button" onclick="getTaprootInfo()">Get Taproot Assets Info</button>
                    </div>
                </div>

                <!-- Step 2: Mint Asset -->
                <div class="card">
                    <div class="step-group">
                        <h3><span class="step-number">2</span> Mint Your First Asset</h3>

                        <div class="input-group">
                            <label>Asset Type:</label>
                            <select id="assetType">
                                <option value="NORMAL">Fungible (NORMAL)</option>
                                <option value="COLLECTIBLE">Collectible (NFT)</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label>Asset Name:</label>
                            <input type="text" id="assetName" placeholder="MyAsset" value="WorkshopCoin">
                            <div class="input-hint">Choose a unique name for your asset</div>
                        </div>

                        <div class="input-group">
                            <label>Amount:</label>
                            <input type="number" id="assetAmount" value="1000" min="1">
                            <div class="input-hint">For collectibles, typically use 1</div>
                        </div>

                        <button class="button" onclick="mintAsset()">üé® Mint Asset</button>
                        <button class="button" onclick="finalizeBatch()">‚úÖ Finalize Batch</button>

                        <div class="info-box">
                            üí° <strong>Two-step process:</strong><br>
                            1. Click "Mint Asset" to add to batch<br>
                            2. Click "Finalize Batch" to commit and broadcast<br>
                            3. Wait ~30 seconds for Auto Mine to confirm
                        </div>
                    </div>
                </div>

                <!-- Step 3: View Assets -->
                <div class="card">
                    <div class="step-group">
                        <h3><span class="step-number">3</span> View Your Assets</h3>
                        <button class="button" onclick="listBalances()">üí∞ View Balances</button>

                        <div class="info-box">
                            üí° Balances are grouped by asset. Multiple UTXOs of the same asset are combined.
                        </div>
                    </div>
                </div>

                <!-- Step 4: Generate Address -->
                <div class="card">
                    <div class="step-group">
                        <h3><span class="step-number">4</span> Generate Receiving Address</h3>

                        <div class="input-group">
                            <label>Asset ID:</label>
                            <input type="text" id="addrAssetId" placeholder="Paste asset_id from your minted asset">
                            <div class="input-hint">Auto-filled from "View Balances"</div>
                        </div>

                        <div class="input-group">
                            <label>Amount:</label>
                            <input type="number" id="addrAmount" placeholder="100" value="100">
                        </div>

                        <button class="button" onclick="generateAddress()">üìç Generate Address</button>
                        <button class="button" onclick="listAddresses()">üì¨ List All Addresses</button>

                        <div class="info-box">
                            üí° Click "List All Addresses" after generating to see your new address
                        </div>
                    </div>
                </div>

                <!-- Step 5: Send Asset -->
                <div class="card">
                    <div class="step-group">
                        <h3><span class="step-number">5</span> Send Asset</h3>

                        <div class="input-group">
                            <label>Taproot Assets Address:</label>
                            <textarea id="sendAddress" placeholder="tap1q..."></textarea>
                            <div class="input-hint">Full Taproot Assets address (starts with tap1)</div>
                        </div>

                        <button class="button" onclick="sendAsset()">üöÄ Send Asset</button>

                        <div class="info-box">
                            üí° If you enabled Auto Mine (30s), wait ~30 seconds. Otherwise mine 6 blocks manually in Polar.
                        </div>
                    </div>
                </div>

                <!-- Step 6: Advanced -->
                <div class="card">
                    <div class="step-group">
                        <h3><span class="step-number">6</span> Advanced Operations</h3>
                        <button class="button" onclick="listTransfers()">üìä List Transfers</button>
                        <button class="button" onclick="getUniverseRoots()">üåç Universe Roots</button>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div class="card">
                    <h3>üì° API Response Console</h3>
                    <div id="response" class="response-viewer">Welcome to the Taproot Assets Workshop! üéâ

Before using this UI:
1. In Polar: Deposit 1 BTC to LND node (alice)
2. In Polar: Enable Auto Mine (30s) for automatic confirmations
3. Wait 30 seconds for deposit to confirm
4. Then start here:
   Step 1: Verify gateway connection
   Step 2: Mint your first asset
   Step 3: View your assets
   Step 4: Generate addresses
   Step 5: Send assets

Gateway URL: http://localhost:8080
Ready to start...</div>
                </div>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; margin-top: 30px; gap: 10px;">
            <a href="/part1-cors-demo/" style="background: white; color: #667eea; border: 2px solid white; padding: 12px 24px; border-radius: 6px; font-size: 16px; font-weight: 600; text-decoration: none; display: inline-block;">‚Üê Back to Part 1</a>
            <a href="/part3-starter/" style="background: white; color: #667eea; border: 2px solid white; padding: 12px 24px; border-radius: 6px; font-size: 16px; font-weight: 600; text-decoration: none; display: inline-block;">Next: Part 3 ‚Üí</a>
        </div>
    </div>

    <script>
        const GATEWAY_URL = 'http://localhost:8080';
        let connectionChecked = false;

        function clearConsole() {
            document.getElementById('response').textContent = 'Console cleared. Ready for next operation...\n';
        }

        function log(message) {
            document.getElementById('response').textContent = message;
        }

        function appendLog(message) {
            document.getElementById('response').textContent += message;
            document.getElementById('response').scrollTop = document.getElementById('response').scrollHeight;
        }

        // Check gateway connection
        async function checkConnection() {
            const statusEl = document.getElementById('status');
            try {
                const response = await fetch(`${GATEWAY_URL}/health`);
                if (response.ok) {
                    statusEl.className = 'status-indicator connected';
                    statusEl.textContent = '‚úÖ Gateway Connected';
                } else {
                    throw new Error('Gateway not responding');
                }
            } catch (error) {
                statusEl.className = 'status-indicator disconnected';
                statusEl.textContent = '‚ùå Gateway Disconnected';
            }
        }

        async function gatewayCall(endpoint, options = {}) {
            log(`üì° Calling: ${options.method || 'GET'} ${endpoint}\n\n‚è≥ Sending request...\n`);

            try {
                const response = await fetch(`${GATEWAY_URL}${endpoint}`, options);
                const data = await response.json();

                if (response.ok) {
                    // Check for error code in response body
                    if (data.code && data.code !== 0 && data.message) {
                        appendLog(`‚ùå Error: ${data.message}\n\n`);
                        appendLog('üì¶ Full Response:\n');
                        appendLog(JSON.stringify(data, null, 2));
                        return null;
                    }

                    appendLog(`‚úÖ Success! Status: ${response.status}\n\n`);
                    appendLog('üì¶ Response Data:\n');
                    appendLog(JSON.stringify(data, null, 2));
                    return data;
                } else {
                    appendLog(`‚ùå Error: ${response.status}\n\n`);
                    appendLog(JSON.stringify(data, null, 2));
                    return null;
                }
            } catch (error) {
                appendLog(`\n‚ùå Network Error: ${error.message}\n`);
                appendLog('\nMake sure the gateway is running!');
                return null;
            }
        }

        // Step 1: Verify
        async function checkHealth() {
            await gatewayCall('/health');
        }

        async function getTaprootInfo() {
            await gatewayCall('/v1/taproot-assets/getinfo');
        }

        // Step 2: Mint Asset
        async function mintAsset() {
            const assetType = document.getElementById('assetType').value;
            const name = document.getElementById('assetName').value;
            const amount = document.getElementById('assetAmount').value;

            if (!name) {
                log('‚ùå Please enter an asset name');
                return;
            }

            const mintRequest = {
                asset: {
                    asset_type: assetType,
                    name: name,
                    amount: amount
                },
                short_response: true
            };

            const result = await gatewayCall('/v1/taproot-assets/assets', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(mintRequest)
            });

            if (result) {
                appendLog('\n\nüéØ Asset added to batch!');
                appendLog('\nüí° NEXT STEP: Click "Finalize Batch" to commit the minting transaction.');
            }
        }

        // Finalize Batch
        async function finalizeBatch() {
            const result = await gatewayCall('/v1/taproot-assets/assets/mint/finalize', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    short_response: true,
                    fee_rate: 1000  // sat/kw
                })
            });

            if (result) {
                appendLog('\n\nüéØ Batch finalized and broadcast!');
                appendLog('\nüí° Wait ~30 seconds for Auto Mine to confirm, then check "List All Assets".');
            }
        }

        // Step 3: View Assets
        async function listBalances() {
            const data = await gatewayCall('/v1/taproot-assets/assets/utxos');

            if (data && data.managed_utxos) {
                const utxos = Object.values(data.managed_utxos);

                if (utxos.length === 0) {
                    appendLog('\n\nNo assets found. Mint an asset first!');
                    return;
                }

                appendLog('\n\nüí∞ ASSET BALANCES:\n');

                // Group assets by asset_id and sum amounts
                const assetMap = new Map();
                let utxoCount = 0;

                utxos.forEach(utxo => {
                    utxo.assets.forEach(asset => {
                        utxoCount++;
                        const genesis = asset.asset_genesis;
                        const assetId = genesis.asset_id;

                        if (assetMap.has(assetId)) {
                            const existing = assetMap.get(assetId);
                            existing.amount += parseInt(asset.amount);
                        } else {
                            assetMap.set(assetId, {
                                name: genesis.name,
                                amount: parseInt(asset.amount),
                                type: genesis.asset_type,
                                assetId: assetId
                            });
                        }
                    });
                });

                // Display grouped balances
                let index = 1;
                let grandTotal = 0;
                let firstAssetId = null;
                for (const [assetId, info] of assetMap) {
                    if (index === 1) firstAssetId = assetId;
                    appendLog(`\n${index}. ${info.name}`);
                    appendLog(`\n   Balance: ${info.amount}`);
                    appendLog(`\n   Type: ${info.type}`);
                    appendLog(`\n   Asset ID: ${info.assetId.substring(0, 20)}...`);
                    appendLog(` üìã [Click to use in Step 4]`);
                    grandTotal += info.amount;
                    index++;
                }

                appendLog(`\n\nüìä Total: ${grandTotal} units across ${assetMap.size} asset(s) in ${utxoCount} UTXO(s)`);

                // Auto-populate first asset ID for convenience
                if (firstAssetId) {
                    document.getElementById('addrAssetId').value = firstAssetId;
                    appendLog('\n\n‚ú® Auto-filled first asset ID in Step 4 - ready to generate address!');
                }
            } else {
                appendLog('\n\nNo assets found. Mint an asset first!');
            }
        }

        async function listAddresses() {
            const data = await gatewayCall('/v1/taproot-assets/addrs');

            if (data && data.addrs) {
                if (data.addrs.length === 0) {
                    appendLog('\n\nüì≠ No addresses generated yet.');
                    appendLog('\nüí° Use Step 4 to generate a receiving address!');
                } else {
                    appendLog(`\n\nüì¨ TAPROOT ASSETS ADDRESSES (${data.addrs.length}):\n`);
                    data.addrs.forEach((addr, idx) => {
                        appendLog(`\n${idx + 1}. ${addr.encoded || addr.addr || 'Address'}`);
                        if (addr.asset_id) {
                            appendLog(`\n   Asset ID: ${addr.asset_id.substring(0, 20)}...`);
                        }
                        if (addr.amount) {
                            appendLog(`\n   Amount: ${addr.amount}`);
                        }
                    });
                }
            }
        }

        // Step 4: Generate Address
        async function generateAddress() {
            const assetId = document.getElementById('addrAssetId').value.trim();
            const amount = document.getElementById('addrAmount').value;

            if (!assetId) {
                log('‚ùå Please enter an asset ID');
                return;
            }

            const addrRequest = {
                asset_id: assetId,
                amt: amount || '0'
            };

            const result = await gatewayCall('/v1/taproot-assets/addrs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(addrRequest)
            });

            if (result && result.encoded) {
                appendLog('\n\n‚úÖ Address generated successfully!');
                appendLog(`\nüìç Address: ${result.encoded}`);

                // Auto-populate send address field for easy testing
                document.getElementById('sendAddress').value = result.encoded;
                appendLog('\n\n‚ú® Auto-filled address in Step 5 - ready to send!');
                appendLog('\nüí° This allows you to test sending to yourself within the same node.');
            }
        }

        // Step 5: Send Asset
        async function sendAsset() {
            const address = document.getElementById('sendAddress').value.trim();

            if (!address) {
                log('‚ùå Please enter a Taproot Assets address');
                return;
            }

            const sendRequest = {
                tap_addrs: [address]
            };

            const result = await gatewayCall('/v1/taproot-assets/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(sendRequest)
            });

            if (result) {
                appendLog('\n\nüéØ Asset minting initiated!');
                appendLog('\nüí° If Auto Mine is enabled, wait ~30 seconds for confirmation.');
                appendLog('\nOtherwise, manually mine 6 blocks in Polar.');
            }
        }

        // Step 6: Advanced
        async function listTransfers() {
            await gatewayCall('/v1/taproot-assets/assets/transfers');
        }

        async function getUniverseRoots() {
            await gatewayCall('/v1/taproot-assets/universe/roots');
        }

        // Check connection on load
        checkConnection();
        setInterval(checkConnection, 5000);
    </script>
</body>
</html>
